<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ái√ßek Temizlik - Ana Sayfa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/responsive-additions.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        /* Anasayfa √ñzel Stiller */
        .homepage-hero {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            border-radius: 16px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .homepage-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .homepage-hero::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .homepage-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .homepage-hero p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .homepage-hero {
                padding: 40px 20px;
            }
            .homepage-hero h1 {
                font-size: 1.8rem;
            }
            .homepage-hero p {
                font-size: 1rem;
            }
        }

        /* Header i√ßin arama √ßubuƒüu */
        .header-search {
            display: none;
            flex: 1;
            max-width: 600px;
            margin: 0 20px;
        }

        @media (min-width: 769px) {
            .header-search {
                display: block;
            }
        }

        .mobile-search {
            display: block;
            padding: 0 15px 15px;
            background: white;
            border-bottom: 1px solid var(--color-border);
        }

        @media (min-width: 769px) {
            .mobile-search {
                display: none;
            }
        }

        /* Kategoriler Grid */
        .categories-section {
            margin-bottom: 50px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--color-border);
        }

        .section-header h2 {
            font-size: 1.8rem;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header h2::before {
            content: '';
            width: 4px;
            height: 28px;
            background: var(--color-primary);
            border-radius: 2px;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (min-width: 480px) {
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 769px) {
            .categories-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 20px;
            }
        }

        .category-card {
            background: var(--color-white);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            text-decoration: none;
            color: var(--color-text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(var(--primary-color-rgb), 0.1), transparent);
            transition: left 0.5s;
        }

        .category-card:hover::before {
            left: 100%;
        }

        .category-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-primary);
            box-shadow: 0 8px 20px rgba(var(--primary-color-rgb), 0.15);
        }

        .category-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            transition: transform 0.3s;
        }

        .category-card:hover .category-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .category-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Kampanyalƒ± √úr√ºnler */
        .featured-products-section {
            margin-bottom: 50px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (min-width: 480px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 769px) {
            .products-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 20px;
            }
        }

        /* Favoriler B√∂l√ºm√º */
        .favorites-section {
            margin-bottom: 50px;
            display: none;
        }

        .favorites-section.show {
            display: block;
        }

        /* Animasyonlar */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Y√ºkleniyor animasyonu */
        .loading-spinner {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
        }

        .loading-spinner::after {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .empty-state p {
            font-size: 1rem;
        }

        /* Badge i√ßin stil */
        .campaign-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(238, 90, 111, 0.4);
            z-index: 2;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
    <script>
        // Prevents flash of wrong theme
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
</head>
<body>

    <header class="site-header">
        <button class="hamburger-menu" aria-label="Men√º">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <a href="/" class="site-logo"></a>
        
        <!-- Desktop i√ßin header i√ßinde arama -->
        <div class="header-search" style="display: flex; justify-content: center;">
            <div style="position: relative; width: 100%; max-width: 500px;">
                <input 
                    type="text" 
                    id="header-search-input" 
                    placeholder="√úr√ºn veya kategori ara..." 
                    style="width: 100%; padding: 10px 40px 10px 15px; font-size: 15px; border: 2px solid var(--color-border); border-radius: 8px; background: var(--color-bg); color: var(--color-text); transition: border-color 0.2s;"
                />
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; pointer-events: none; color: var(--color-text-muted);">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <div id="header-search-results" style="display: none;"></div>
            </div>
        </div>

        <div class="user-controls" id="user-controls-container"></div>
    </header>

    <!-- Mobil i√ßin arama √ßubuƒüu -->
    <div class="mobile-search">
        <div style="position: relative;">
            <input 
                type="text" 
                id="mobile-search-input" 
                placeholder="√úr√ºn veya kategori ara..." 
                style="width: 100%; padding: 12px 40px 12px 15px; font-size: 16px; border: 2px solid var(--color-border); border-radius: 8px; background: var(--color-bg); color: var(--color-text); transition: border-color 0.2s;"
            />
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; pointer-events: none; color: var(--color-text-muted);">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <div id="mobile-search-results" style="display: none;"></div>
        </div>
    </div>

    <main class="container">
        <!-- Hero B√∂l√ºm√º -->
        <div class="homepage-hero">
            <h1>üå∏ √ái√ßek Temizlik'e Ho≈ü Geldiniz</h1>
            <p>Temizlik ve hijyen √ºr√ºnlerinde kalite ve g√ºvenin adresi</p>
        </div>

        <!-- Kategoriler B√∂l√ºm√º -->
        <section class="categories-section">
            <div class="section-header">
                <h2>Kategoriler</h2>
            </div>
            <div id="categories-container" class="categories-grid">
                <div class="loading-spinner">Kategoriler y√ºkleniyor...</div>
            </div>
        </section>

        <!-- Kampanyalƒ± √úr√ºnler B√∂l√ºm√º -->
        <section class="featured-products-section">
            <div class="section-header">
                <h2>Kampanyalƒ± √úr√ºnler</h2>
                <a href="/products.html" style="color: var(--color-primary); font-size: 0.95rem; font-weight: 600; text-decoration: none; transition: opacity 0.2s;">
                    T√ºm√ºn√º G√∂r ‚Üí
                </a>
            </div>
            <div id="featured-products-container" class="products-grid">
                <div class="loading-spinner">Kampanyalƒ± √ºr√ºnler y√ºkleniyor...</div>
            </div>
        </section>

        <!-- Favoriler B√∂l√ºm√º (Sadece giri≈ü yapan kullanƒ±cƒ±lar i√ßin) -->
        <section class="favorites-section" id="favorites-section">
            <div class="section-header">
                <h2>Favorilerim</h2>
                <a href="/favorites.html" style="color: var(--color-primary); font-size: 0.95rem; font-weight: 600; text-decoration: none; transition: opacity 0.2s;">
                    T√ºm√ºn√º G√∂r ‚Üí
                </a>
            </div>
            <div id="favorites-container" class="products-grid">
                <div class="loading-spinner">Favoriler y√ºkleniyor...</div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-links">
            <a href="/help.html">Yardƒ±m</a>
            <a href="/faq.html">Sƒ±k√ßa Sorulan Sorular</a>
            <a href="/about.html">Hakkƒ±mƒ±zda</a>
            <a href="/contact.html">ƒ∞leti≈üim</a>
        </div>
        <p class="copyright">&copy; 2025 √ái√ßek Temizlik. T√ºm Haklarƒ± Saklƒ±dƒ±r.</p>
    </footer>

    <div id="toast-container"></div>

    <script src="/common.js"></script>
    <script>
        const categoriesContainer = document.getElementById('categories-container');
        const featuredProductsContainer = document.getElementById('featured-products-container');
        const favoritesSection = document.getElementById('favorites-section');
        const favoritesContainer = document.getElementById('favorites-container');

        // Arama inputlarƒ±
        const headerSearchInput = document.getElementById('header-search-input');
        const headerSearchResults = document.getElementById('header-search-results');
        const mobileSearchInput = document.getElementById('mobile-search-input');
        const mobileSearchResults = document.getElementById('mobile-search-results');

        let allCategories = [];
        let allProducts = [];
        let searchTimeout = null;

        // Kategori ikonlarƒ± mapping
        const categoryIcons = {
            'ki≈üisel hijyen': 'üßº',
            'ev temizliƒüi': 'üè†',
            'sa√ß bakƒ±m': 'üíá',
            'mutfak': 'üç≥',
            'banyo': 'üõÅ',
            '√ßama≈üƒ±r': 'üëï',
            'bula≈üƒ±k': 'üçΩÔ∏è',
            'temizlik ara√ßlarƒ±': 'üßπ',
            'default': '‚ú®'
        };

        function getCategoryIcon(categoryName) {
            const name = categoryName.toLowerCase();
            for (const key in categoryIcons) {
                if (name.includes(key)) {
                    return categoryIcons[key];
                }
            }
            return categoryIcons.default;
        }

        // Kategorileri y√ºkle
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                if (response.ok) {
                    allCategories = await response.json();
                    displayCategories();
                } else {
                    categoriesContainer.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">üìÇ</div>
                            <h3>Kategori bulunamadƒ±</h3>
                            <p>Hen√ºz kategori eklenmemi≈ü</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Kategoriler y√ºklenemedi:', error);
                categoriesContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Hata olu≈ütu</h3>
                        <p>Kategoriler y√ºklenirken bir sorun olu≈ütu</p>
                    </div>
                `;
            }
        }

        // Kategorileri g√∂ster
        function displayCategories() {
            if (allCategories.length === 0) {
                categoriesContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üìÇ</div>
                        <h3>Kategori bulunamadƒ±</h3>
                    </div>
                `;
                return;
            }

            categoriesContainer.innerHTML = allCategories.map(category => `
                <a href="/category.html?id=${category.id}" class="category-card fade-in">
                    <span class="category-icon">${getCategoryIcon(category.name)}</span>
                    <div class="category-name">${category.name}</div>
                </a>
            `).join('');
        }

        // √úr√ºnleri y√ºkle
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                if (response.ok) {
                    const data = await response.json();
                    allProducts = data;
                    displayFeaturedProducts();
                } else {
                    featuredProductsContainer.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-state-icon">üì¶</div>
                            <h3>√úr√ºn bulunamadƒ±</h3>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('√úr√ºnler y√ºklenemedi:', error);
                featuredProductsContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Hata olu≈ütu</h3>
                        <p>√úr√ºnler y√ºklenirken bir sorun olu≈ütu</p>
                    </div>
                `;
            }
        }

        // Kampanyalƒ± √ºr√ºnleri g√∂ster (≈üimdilik ilk 6 aktif √ºr√ºn√º g√∂steriyoruz)
        function displayFeaturedProducts() {
            const token = localStorage.getItem('token');
            const user = token ? parseJwt(token) : null;
            const isAdmin = user && user.role === 'admin';

            // Aktif √ºr√ºnleri filtrele
            let activeProducts = allProducts.filter(p => p.is_active);
            
            // Admin deƒüilse stokta olmayanlarƒ± da filtrele
            if (!isAdmin) {
                activeProducts = activeProducts.filter(p => p.stock_quantity > 0);
            }

            const featuredProducts = activeProducts.slice(0, 6);

            if (featuredProducts.length === 0) {
                featuredProductsContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üéÅ</div>
                        <h3>Kampanyalƒ± √ºr√ºn yok</h3>
                        <p>Yakƒ±nda kampanyalƒ± √ºr√ºnler eklenecek!</p>
                    </div>
                `;
                return;
            }

            featuredProductsContainer.innerHTML = featuredProducts.map(product => 
                createProductCard(product, 'featured') // 'featured' page identifier
            ).join('');

            // Favori butonlarƒ±nƒ± ba≈ülat ve sepete ekle butonlarƒ±nƒ± ekle
            featuredProducts.forEach(product => {
                initializeFavoriteButton(product.id, `hp-featured-${product.id}`);
            });
            addCartButtonListeners();
        }

        // √úr√ºn kartƒ± olu≈ütur (products.html'deki gibi)
        function createProductCard(product, section = 'featured') {
            const token = localStorage.getItem('token');
            const user = token ? parseJwt(token) : null;
            const isLoggedIn = !!token;
            
            // Favoriler API'den geldiƒüinde product_id olarak gelir, normal √ºr√ºnlerde id olarak
            const productId = product.id || product.product_id;
            
            const imageHTML = product.image_url 
                ? `<img src="${product.image_url}" alt="${product.name}">` 
                : `<div class="product-image-placeholder-content"><span>(√úr√ºn Fotoƒürafƒ±)</span></div>`;

            const outOfStock = product.stock_quantity <= 0;
            const price = parseFloat(product.price).toFixed(2);

            // Favori butonu (sadece giri≈ü yapmƒ±≈ü kullanƒ±cƒ±lar i√ßin)
            // section bazlƒ± unique page identifier
            const favoriteBtn = isLoggedIn ? createFavoriteButton(productId, `hp-${section}-${productId}`) : '';

            let buttonHTML = '';
            let priceClass = '';
            if (outOfStock) {
                buttonHTML = `<button class="out-of-stock-btn btn" disabled>Stokta Yok</button>`;
                priceClass = "price price-out-of-stock";
            } else {
                buttonHTML = `<button class="add-to-cart-btn btn btn-primary" data-product-id="${productId}">Sepete Ekle</button>`;
                priceClass = "price";
            }

            return `
                <div class="product fade-in" style="display: flex; flex-direction: column;">
                    <span class="campaign-badge" style="left: 10px; right: auto;">Kampanya</span>
                    <div class="product-image-area" style="position: relative;">
                        ${imageHTML}
                        ${favoriteBtn}
                    </div>
                    <a href="/product.html?id=${productId}" style="text-decoration: none; color: inherit; display: block; flex: 1; display: flex; flex-direction: column;">
                        <div class="product-info" style="pointer-events: none; flex: 1; display: flex; flex-direction: column; padding: 15px 10px 10px;">
                            <h2 style="margin: 0 0 auto 0; font-size: 1rem;">${product.name}</h2>
                            <p class="${priceClass}" style="margin: 10px 0 0 0;">${price} TL</p>
                        </div>
                    </a>
                    <div style="padding: 0 10px 10px; pointer-events: auto;">
                        ${buttonHTML}
                    </div>
                </div>
            `;
        }

        // Favorileri y√ºkle
        async function loadFavorites() {
            const token = localStorage.getItem('token');
            if (!token) {
                favoritesSection.classList.remove('show');
                return;
            }

            try {
                const response = await fetch('/api/favorites', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const favorites = await response.json();
                    
                    // userFavorites array'ini g√ºncelle
                    userFavorites = favorites.map(f => f.id);
                    
                    if (favorites.length > 0) {
                        favoritesSection.classList.add('show');
                        displayFavorites(favorites);
                    } else {
                        favoritesSection.classList.remove('show');
                    }
                } else {
                    favoritesSection.classList.remove('show');
                }
            } catch (error) {
                console.error('Favoriler y√ºklenemedi:', error);
                favoritesSection.classList.remove('show');
            }
        }

        // Favorileri g√∂ster
        function displayFavorites(favorites) {
            const favoriteProducts = favorites.slice(0, 6);
            
            // √ñnce container'ƒ± tamamen temizle
            favoritesContainer.innerHTML = '';
            
            if (favoriteProducts.length === 0) {
                favoritesSection.classList.remove('show');
                return;
            }
            
            favoritesContainer.innerHTML = favoriteProducts.map(fav => 
                createProductCard(fav, 'favorites') // 'favorites' page identifier
            ).join('');

            // K√º√ß√ºk bir gecikme ile favori butonlarƒ±nƒ± ba≈ülat (DOM'un hazƒ±r olmasƒ± i√ßin)
            setTimeout(() => {
                favoriteProducts.forEach(product => {
                    const productId = product.id || product.product_id;
                    initializeFavoriteButton(productId, `hp-favorites-${productId}`);
                });
                addCartButtonListeners();
            }, 100);
        }

        // Sepete ekle buton event listeners
        function addCartButtonListeners() {
            document.querySelectorAll('.add-to-cart-btn:not(.cart-listener-added)').forEach(button => {
                button.classList.add('cart-listener-added'); // √áift eklemeyi √∂nle
                
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Butonu devre dƒ±≈üƒ± bƒ±rak (√ßift tƒ±klama √∂nleme)
                    if (button.disabled) return;
                    button.disabled = true;
                    
                    // Buton efekti
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        button.style.transform = 'scale(1)';
                    }, 150);
                    
                    const productId = parseInt(button.dataset.productId);
                    const product = allProducts.find(p => p.id === productId);
                    
                    if (!product || !product.is_active || product.stock_quantity <= 0) {
                        showToast('Bu √ºr√ºn ≈üu anda mevcut deƒüil.', 'error');
                        button.disabled = false;
                        return;
                    }
                    
                    const token = localStorage.getItem('token');
                    
                    try {
                        if (token) {
                            // Giri≈ü yapmƒ±≈ü kullanƒ±cƒ± - Backend'e kaydet
                            const response = await fetch('/api/cart/items', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ productId: productId, quantity: 1 })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || 'Sepete eklenemedi.');
                            }
                            showToast(`${product.name} sepete eklendi! üõí`, 'success');
                            updateCartBadge();
                        } else {
                            // Giri≈ü yapmamƒ±≈ü kullanƒ±cƒ± - localStorage'a kaydet
                            let cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                            const existingItem = cart.find(item => item.product_id === productId);
                            
                            if (existingItem) {
                                existingItem.quantity += 1;
                            } else {
                                cart.push({
                                    product_id: productId,
                                    quantity: 1,
                                    product: product
                                });
                            }
                            
                            localStorage.setItem('guestCart', JSON.stringify(cart));
                            showToast(`${product.name} sepete eklendi! üõí`, 'success');
                            updateCartBadge();
                        }
                    } catch (error) {
                        console.error('Sepete ekleme hatasƒ±:', error);
                        showToast(error.message || 'Sepete eklenirken bir hata olu≈ütu.', 'error');
                    } finally {
                        // Butonu tekrar aktif et
                        setTimeout(() => {
                            button.disabled = false;
                        }, 500);
                    }
                });
            });
        }

        // Arama fonksiyonu (products.html'den kopyalandƒ±)
        async function performSearch(query, resultsElement) {
            if (!query || query.trim().length < 2) {
                resultsElement.style.display = 'none';
                return;
            }

            const token = localStorage.getItem('token');
            const user = token ? parseJwt(token) : null;
            const isAdmin = user && user.role === 'admin';

            query = query.toLowerCase().trim();

            // √úr√ºnlerde ara
            let filteredProducts = allProducts.filter(product => {
                const matchesQuery = product.name.toLowerCase().includes(query);
                if (!isAdmin && !product.is_active) return false;
                return matchesQuery;
            });

            // Kategorilerde ara
            const matchedCategories = allCategories.filter(cat => 
                cat.name.toLowerCase().includes(query)
            );

            // Sonu√ßlarƒ± g√∂ster
            if (filteredProducts.length === 0 && matchedCategories.length === 0) {
                resultsElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--color-text-muted);">
                        <div style="font-size: 36px; margin-bottom: 8px; opacity: 0.5;">üîç</div>
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 3px;">Sonu√ß bulunamadƒ±</div>
                        <div style="font-size: 12px;">"${query}" i√ßin e≈üle≈üme yok</div>
                    </div>
                `;
                resultsElement.style.display = 'block';
                return;
            }

            let resultsHTML = '<div style="padding: 12px;">';

            // Kategori sonu√ßlarƒ±
            if (matchedCategories.length > 0) {
                resultsHTML += '<div style="margin-bottom: 12px;"><h3 style="font-size: 11px; font-weight: 600; color: var(--color-text-muted); margin: 0 0 8px 5px; text-transform: uppercase; letter-spacing: 0.5px;">Kategoriler</h3>';
                matchedCategories.forEach(cat => {
                    resultsHTML += `
                        <a href="/category.html?id=${cat.id}" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--color-bg); border-radius: 6px; margin-bottom: 6px; text-decoration: none; color: var(--color-text); transition: all 0.2s; border: 1px solid var(--color-border);">
                            <div style="width: 32px; height: 32px; background: var(--color-primary-light-alpha); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px;">
                                ${getCategoryIcon(cat.name)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px;">${cat.name}</div>
                                <div style="font-size: 11px; color: var(--color-text-muted);">Kategoriye git</div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.3;">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    `;
                });
                resultsHTML += '</div>';
            }

            // √úr√ºn sonu√ßlarƒ±
            if (filteredProducts.length > 0) {
                resultsHTML += '<div><h3 style="font-size: 11px; font-weight: 600; color: var(--color-text-muted); margin: 0 0 8px 5px; text-transform: uppercase; letter-spacing: 0.5px;">√úr√ºnler</h3>';
                
                const productsToShow = filteredProducts.slice(0, 8);
                
                productsToShow.forEach(product => {
                    const imageHTML = product.image_url 
                        ? `<img src="${product.image_url}" alt="${product.name}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid var(--color-border);">` 
                        : `<div style="width: 48px; height: 48px; background: var(--color-bg-light); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid var(--color-border);">üì¶</div>`;
                    
                    const outOfStock = product.stock_quantity <= 0;
                    const inactive = !product.is_active;
                    
                    let statusBadge = '';
                    if (inactive && isAdmin) {
                        statusBadge = '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 6px; font-weight: 600;">SATI≈û DI≈ûI</span>';
                    } else if (outOfStock) {
                        statusBadge = '<span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 6px; font-weight: 600;">STOKTA YOK</span>';
                    }

                    resultsHTML += `
                        <a href="/product.html?id=${product.id}" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--color-bg); border-radius: 6px; margin-bottom: 6px; text-decoration: none; color: var(--color-text); transition: all 0.2s; border: 1px solid var(--color-border);">
                            ${imageHTML}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.name}</span>
                                    ${statusBadge}
                                </div>
                                <div style="font-size: 14px; color: var(--color-primary); font-weight: 700;">${parseFloat(product.price).toFixed(2)} TL</div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.3; flex-shrink: 0;">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    `;
                });

                if (filteredProducts.length > 8) {
                    resultsHTML += `<div style="padding: 10px; text-align: center; color: var(--color-text-muted); font-size: 11px; background: var(--color-bg-light); border-radius: 6px; margin-top: 6px;">ve ${filteredProducts.length - 8} √ºr√ºn daha...</div>`;
                }
                
                resultsHTML += '</div>';
            }

            resultsHTML += '</div>';
            resultsElement.innerHTML = resultsHTML;
            resultsElement.style.display = 'block';
        }

        // Header arama event listeners
        if (headerSearchInput) {
            headerSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value, headerSearchResults);
                }, 300);
            });

            headerSearchInput.addEventListener('focus', () => {
                headerSearchInput.style.borderColor = 'var(--color-primary)';
                headerSearchInput.style.boxShadow = '0 0 0 3px var(--color-primary-light-alpha)';
            });

            headerSearchInput.addEventListener('blur', () => {
                headerSearchInput.style.borderColor = 'var(--color-border)';
                headerSearchInput.style.boxShadow = 'none';
            });

            headerSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstLink = headerSearchResults.querySelector('a');
                    if (firstLink) window.location.href = firstLink.href;
                } else if (e.key === 'Escape') {
                    headerSearchResults.style.display = 'none';
                    headerSearchInput.value = '';
                }
            });
        }

        // Mobil arama event listeners
        if (mobileSearchInput) {
            mobileSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(e.target.value, mobileSearchResults);
                }, 300);
            });

            mobileSearchInput.addEventListener('focus', () => {
                mobileSearchInput.style.borderColor = 'var(--color-primary)';
                mobileSearchInput.style.boxShadow = '0 0 0 3px var(--color-primary-light-alpha)';
            });

            mobileSearchInput.addEventListener('blur', () => {
                mobileSearchInput.style.borderColor = 'var(--color-border)';
                mobileSearchInput.style.boxShadow = 'none';
            });

            mobileSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstLink = mobileSearchResults.querySelector('a');
                    if (firstLink) window.location.href = firstLink.href;
                } else if (e.key === 'Escape') {
                    mobileSearchResults.style.display = 'none';
                    mobileSearchInput.value = '';
                }
            });
        }

        // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
        document.addEventListener('click', (e) => {
            if (headerSearchInput && !headerSearchInput.contains(e.target) && !headerSearchResults.contains(e.target)) {
                headerSearchResults.style.display = 'none';
            }
            if (mobileSearchInput && !mobileSearchInput.contains(e.target) && !mobileSearchResults.contains(e.target)) {
                mobileSearchResults.style.display = 'none';
            }
        });

        // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak (common.js y√ºklendikten sonra)
        window.addEventListener('load', async () => {
            // Favori bilgilerini y√ºkle (common.js'den)
            await loadUserFavorites();
            
            await loadCategories();
            await loadProducts();
            await loadFavorites();
            
            // Favori deƒüi≈üikliklerini dinle
            window.addEventListener('favoriteChanged', async (event) => {
                const { productId, action } = event.detail;
                
                // userFavorites g√ºncelle
                await loadUserFavorites();
                
                // Favorilerim b√∂l√ºm√ºn√º yeniden y√ºkle
                await loadFavorites();
                
                // Kampanyalƒ± √ºr√ºnler b√∂l√ºm√ºn√º de yeniden y√ºkle
                await loadProducts();
            });
        });
    </script>
</body>
</html>
