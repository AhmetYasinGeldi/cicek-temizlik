<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürünü Düzenle - Çiçek Temizlik</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script>
        // Prevents flash of wrong theme
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <style>
        .form-actions { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .form-actions button { flex-grow: 1; padding: 12px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; font-weight: 500; }
        .save-btn { background-color: var(--color-primary); color: var(--color-white); }
        .save-btn:hover { background-color: var(--color-primary-hover); }
        .delete-btn { background-color: var(--color-danger); color: var(--color-white); }
        .delete-btn:hover { background-color: var(--color-danger-hover); }
        #current-image-container img { max-width: 200px; max-height: 200px; border-radius: 5px; border: 1px solid #ccc; display: block; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 30px; }
        .modal-content { background-color: #fefefe; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: 8px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 10; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: black; text-decoration: none; }
        .crop-image-container { width: 100%; height: 500px; margin-bottom: 20px; overflow: hidden; border: 2px solid #ddd; border-radius: 8px; background-color: #f5f5f5; }
        #image-to-crop { display: block; max-width: 100%; max-height: 100%; }
        .modal-actions { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .modal-actions button { padding: 10px 20px; }
    </style>
</head>
<body>

    <header class="site-header">
        <button class="hamburger-menu" onclick="toggleSidePanel()" aria-label="Menü">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <a href="/" class="site-logo"></a>
        <nav class="center-nav"></nav>
        <div class="user-controls" id="user-controls-container"></div>
    </header>

    <main class="container">
        <div class="form-container" id="product-form-container">
            <h1>Ürünü Yönet</h1>
            <a href="/">&larr; Ana Panele Dön</a>
            <hr style="margin: 15px 0;">
            <form id="edit-product-form">
                <div class="form-group">
                    <label for="name">Ürün Adı:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="price">Fiyat:</label>
                    <input type="number" id="price" name="price" step="0.01" required min="0.01">
                </div>
                <div class="form-group">
                    <label for="description">Açıklama:</label>
                    <textarea id="description" name="description" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label>Mevcut Fotoğraf:</label>
                    <div id="current-image-container" style="margin-bottom: 15px;"><p><i>Yükleniyor...</i></p></div>
                    <label for="productImage">Fotoğrafı Değiştir/Ekle:</label>
                    <div style="display: flex; align-items: center;">
                        <div class="file-input-wrapper">
                            <label for="productImage" class="file-input-label">Dosya Seç</label>
                            <input type="file" id="productImage" name="productImage" accept="image/*">
                            <span class="file-name"></span>
                        </div>
                        <small style="margin-left: 10px;">Yeni bir fotoğraf seçerseniz mevcut olan silinir.</small>
                    </div>
                    <div class="checkbox-group" id="remove-image-checkbox-container" style="margin-top: 10px; display: none;">
                       <input type="checkbox" id="removeCurrentImage" name="removeCurrentImage" value="true">
                       <label for="removeCurrentImage" style="font-weight: normal; margin-bottom: 0;">Mevcut fotoğrafı kaldır</label>
                    </div>
                </div>
                <div class="form-group">
                   <label for="stock_quantity">Stok Miktarı:</label>
                   <input type="number" id="stock_quantity" name="stock_quantity" required min="0">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="is_active" name="is_active">
                    <label for="is_active" style="font-weight: normal; margin-bottom: 0;">Satışta mı?</label>
                </div>
                <div class="form-group setting-item">
                    <label for="out_of_stock_display_rule">Stoğu Bittiğinde Davranış:</label>
                    <select id="out_of_stock_display_rule" name="out_of_stock_display_rule">
                        <option value="default">Genel Ayarı Kullan (Varsayılan)</option>
                        <option value="show">Her Zaman Göster ("Stokta Yok" olarak)</option>
                        <option value="hide">Her Zaman Gizle</option>
                    </select>
                    <small>Bu ürüne özel bir kural belirleyebilirsiniz.</small>
                </div>
                <div class="form-group setting-item">
                    <label for="critical_stock_threshold">Ürüne Özel Kritik Stok Eşiği (Adet):</label>
                    <input type="number" id="critical_stock_threshold" name="critical_stock_threshold" min="0" placeholder="Örn: 5">
                    <small>Stok bu adedin altına düştüğünde uyarılır. Boş bırakırsanız, genel ayar kullanılır.</small>
                </div>
                
                <!-- Kategori Yönetimi -->
                <div class="form-group">
                    <label>Kategoriler:</label>
                    <div id="product-categories" style="margin-bottom: 10px;">
                        <p style="color: var(--color-text-muted);"><i>Yükleniyor...</i></p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <select id="category-select" style="flex: 1;">
                            <option value="">-- Kategori Seçin --</option>
                        </select>
                        <button type="button" id="add-category-btn" class="btn btn-secondary">Kategori Ekle</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Değişiklikleri Kaydet</button>
                    <button type="button" id="delete-button" class="btn btn-danger">Bu Ürünü Sil</button>
                </div>
            </form>
        </div>
    </main>

     <div id="crop-modal" class="modal">
         <div class="modal-content">
             <span class="close-modal-btn">&times;</span>
             <h2>Fotoğrafı Kırp</h2>
             <p style="color: var(--color-text-muted); margin-bottom: 15px;">Fotoğrafı sürükleyerek konumlandırın, köşelerden boyutlandırın</p>
             <div class="crop-image-container">
                 <img id="image-to-crop" src="#" alt="Kırpılacak Resim">
             </div>
             <div class="modal-actions">
                 <button type="button" class="cancel-modal-btn btn btn-secondary">İptal</button>
                 <button id="crop-button" class="btn btn-primary">Kırp ve Kullan</button>
             </div>
         </div>
     </div>

    <footer class="site-footer">
        <div class="footer-links">
             <a href="#">Yardım</a><a href="#">Sıkça Sorulan Sorular</a><a href="#">Hakkımızda</a><a href="#">İletişim</a>
        </div>
        <p class="copyright">&copy; 2025 Çiçek Temizlik. Tüm Hakları Saklıdır.</p>
    </footer>

    <div id="toast-container"></div>

    <script src="/common.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const form = document.getElementById('edit-product-form');
        const nameInput = document.getElementById('name'); const priceInput = document.getElementById('price');
        const descriptionInput = document.getElementById('description'); const stockInput = document.getElementById('stock_quantity');
        const activeCheckbox = document.getElementById('is_active'); const displayRuleSelect = document.getElementById('out_of_stock_display_rule');
        const deleteButton = document.getElementById('delete-button'); const criticalStockInput = document.getElementById('critical_stock_threshold');
        const imageInput = document.getElementById('productImage');
        const removeImageCheckbox = document.getElementById('removeCurrentImage');
        const urlParams = new URLSearchParams(window.location.search); const productId = urlParams.get('id');
        const fileNameSpan = document.querySelector('.file-name');

        const modal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropButton = document.getElementById('crop-button');
        const closeModalBtn = modal.querySelector('.close-modal-btn');
        const cancelModalBtn = modal.querySelector('.cancel-modal-btn');
        let cropper = null;
        let croppedImageBlob = null;
        let originalFileName = '';

        function openModal() { modal.style.display = 'block'; }
        function closeModal() {
            modal.style.display = 'none';
            if (cropper) { cropper.destroy(); cropper = null; }
            imageToCrop.src = '#';
            imageInput.value = '';
        }
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });

        async function loadProduct() {
            const token = localStorage.getItem('token');
            if (!productId) { document.getElementById('product-form-container').innerHTML = '<h1>Düzenlenecek ürün ID\'si bulunamadı.</h1><a href="/">&larr; Ana Sayfaya Dön</a>'; return; }

            try {
                const headers = { 'Authorization': `Bearer ${token}` };
                const response = await fetch(`/api/products/${productId}`, { headers: headers });
                if (!response.ok) {
                     const status = response.status;
                     if (status !== 401 && status !== 403) {
                         throw new Error('Ürün bilgileri getirilemedi.');
                     } else {
                         throw new Error('Ürün bilgilerini getirme yetkiniz yok.');
                     }
                }
                const product = await response.json();

                document.title = `Düzenle: ${product.name} - Çiçek Temizlik`;
                nameInput.value = product.name;
                priceInput.value = product.price;
                descriptionInput.value = product.description;
                stockInput.value = product.stock_quantity;
                activeCheckbox.checked = product.is_active;
                displayRuleSelect.value = product.out_of_stock_display_rule;
                criticalStockInput.value = product.critical_stock_threshold ?? '';

                const imageContainer = document.getElementById('current-image-container');
                const removeCheckboxContainer = document.getElementById('remove-image-checkbox-container');
                if (product.image_url) {
                    imageContainer.innerHTML = `<img src="${product.image_url}" alt="${product.name}">`;
                    removeCheckboxContainer.style.display = 'flex';
                    removeImageCheckbox.checked = false;
                } else {
                    imageContainer.innerHTML = `<p><i>Bu ürün için fotoğraf yüklenmemiş.</i></p>`;
                    removeCheckboxContainer.style.display = 'none';
                }
                
                // Kategorileri yükle
                await loadCategories();
                await loadProductCategories();
            } catch (error) {
                console.error('Hata:', error);
                showToast(error.message, 'error');
                document.getElementById('product-form-container').innerHTML = `<h1>Hata</h1><p>${error.message}</p><a href="/">&larr; Ana Sayfaya Dön</a>`;
            }
        }
        
        // Tüm kategorileri yükle
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error('Kategoriler yüklenemedi');
                const categories = await response.json();
                
                const select = document.getElementById('category-select');
                select.innerHTML = '<option value="">-- Kategori Seçin --</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            } catch (error) {
                console.error('Kategoriler yüklenirken hata:', error);
            }
        }
        
        // Ürünün kategorilerini yükle
        async function loadProductCategories() {
            try {
                const response = await fetch(`/api/categories/product/${productId}`);
                if (!response.ok) throw new Error('Ürün kategorileri yüklenemedi');
                const categories = await response.json();
                
                const container = document.getElementById('product-categories');
                if (categories.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-text-muted);"><i>Bu ürüne henüz kategori eklenmemiş.</i></p>';
                } else {
                    container.innerHTML = categories.map(cat => `
                        <div style="display: inline-block; background-color: var(--color-primary); color: white; padding: 6px 12px; border-radius: 15px; margin-right: 8px; margin-bottom: 8px;">
                            ${cat.name}
                            <button type="button" onclick="removeCategory(${cat.id})" style="background: none; border: none; color: white; cursor: pointer; margin-left: 5px; font-weight: bold;">×</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Ürün kategorileri yüklenirken hata:', error);
            }
        }
        
        // Kategori ekle
        document.getElementById('add-category-btn').addEventListener('click', async () => {
            const categoryId = document.getElementById('category-select').value;
            if (!categoryId) {
                showToast('Lütfen bir kategori seçin', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/categories/product/${productId}/category/${categoryId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Kategori eklenemedi');
                }
                
                showToast('Kategori eklendi!', 'success');
                document.getElementById('category-select').value = '';
                loadProductCategories();
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showToast(error.message, 'error');
            }
        });
        
        // Kategori kaldır
        window.removeCategory = async function(categoryId) {
            try {
                const response = await fetch(`/api/categories/product/${productId}/category/${categoryId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Kategori kaldırılamadı');
                
                showToast('Kategori kaldırıldı!', 'success');
                loadProductCategories();
            } catch (error) {
                console.error('Kategori kaldırılırken hata:', error);
                showToast('Bir hata oluştu', 'error');
            }
        };

        imageInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files && files.length > 0) {
                fileNameSpan.textContent = files[0].name;
                removeImageCheckbox.checked = false;
                croppedImageBlob = null;

                const file = files[0];
                originalFileName = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageToCrop.src = e.target.result;
                    openModal();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.9,
                        responsive: true,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
                    });
                };
                reader.readAsDataURL(file);
            } else {
                 croppedImageBlob = null;
                 originalFileName = '';
                 fileNameSpan.textContent = '';
            }
        });

        cropButton.addEventListener('click', () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 500, height: 500, imageSmoothingQuality: 'high' });
            canvas.toBlob((blob) => {
                if (blob) {
                    croppedImageBlob = blob;
                    removeImageCheckbox.checked = false;
                    console.log('Yeni resim kırpıldı:', croppedImageBlob);
                    const previewUrl = URL.createObjectURL(blob);
                    document.getElementById('current-image-container').innerHTML = `<img src="${previewUrl}" alt="Yeni Resim Önizleme">`;
                    document.getElementById('remove-image-checkbox-container').style.display = 'flex';
                    closeModal();
                } else {
                    console.error('Blob oluşturulamadı.');
                    showToast('Resim kırpılırken bir hata oluştu.', 'error');
                    closeModal();
                }
            }, 'image/jpeg', 0.9);
        });

        deleteButton.addEventListener('click', async () => {
             const token = localStorage.getItem('token');
             if (!token) { showToast('Bu işlem için giriş yapmalısınız.', 'error'); return; }
             const confirmed = await showConfirm('Bu ürünü kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.');
             if (!confirmed) { return; }
             try {
                 const response = await fetch(`/api/products/${productId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                 if (!response.ok) throw new Error('Silme işlemi başarısız.');
                 showToast('Ürün başarıyla silindi!');
                 setTimeout(() => window.location.href = '/', 2000);
             } catch (error) { showToast(error.message, 'error'); }
        });

        form.addEventListener('submit', async (event) => {
             event.preventDefault();
             const token = localStorage.getItem('token');
             if (!token) { showToast('Bu işlem için giriş yapmalısınız.', 'error'); return; }

             const formData = new FormData();
             formData.append('name', nameInput.value);
             formData.append('price', parseFloat(priceInput.value));
             formData.append('description', descriptionInput.value);
             formData.append('stock_quantity', parseInt(stockInput.value));
             formData.append('is_active', activeCheckbox.checked);
             formData.append('out_of_stock_display_rule', displayRuleSelect.value);
             if (criticalStockInput.value !== '') {
                 formData.append('critical_stock_threshold', parseInt(criticalStockInput.value));
             }

             if (croppedImageBlob) {
                 let fileName = originalFileName || 'edited_image.jpg';
                 const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                 fileName = nameWithoutExt + '.jpg';
                 formData.append('productImage', croppedImageBlob, fileName);
             } else if (removeImageCheckbox.checked) {
                 formData.append('removeCurrentImage', 'true');
             }

             try {
                 const response = await fetch(`/api/products/${productId}`, {
                     method: 'PUT',
                     headers: { 'Authorization': `Bearer ${token}` },
                     body: formData
                 });
                 if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.error || 'Güncelleme başarısız.');
                 }
                 showToast('Ürün başarıyla güncellendi!');
                 setTimeout(() => { window.location.href = `/product.html?id=${productId}`; }, 1500);
             } catch (error) {
                 console.error('Güncelleme hatası:', error);
                 showToast(error.message, 'error');
             }
        });

        function setupUserMenu() {
            const menuButton = document.getElementById('user-menu-button');
            const dropdown = document.getElementById('user-dropdown-content');
            if (!menuButton || !dropdown) return;
             menuButton.addEventListener('click', () => dropdown.classList.toggle('show'));
             window.addEventListener('click', (event) => {
                 if (!menuButton.contains(event.target) && !dropdown.contains(event.target)) {
                      if (dropdown.classList.contains('show')) dropdown.classList.remove('show');
                 }
             });
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => { localStorage.removeItem('token'); window.location.href = '/login.html'; });
            }
        }

        const userControlsContainer = document.getElementById('user-controls-container');
        function setupHeader() {
            const token = localStorage.getItem('token');
            userControlsContainer.innerHTML = '';
            let user = null;
            if (token) user = parseJwt(token);

            if (user && user.role === 'admin') {
                userControlsContainer.innerHTML = `
                    <div class="theme-toggle-group">
                        <button id="theme-light-btn" class="theme-toggle-btn" data-theme="light">
                            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        </button>
                        <button id="theme-dark-btn" class="theme-toggle-btn" data-theme="dark">
                            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        </button>
                    </div>
                    <div class="user-dropdown">
                        <button id="user-menu-button" class="user-menu-button">
                            ${user.firstName} (Admin) <span class="arrow">&#9662;</span>
                        </button>
                        <div id="user-dropdown-content" class="dropdown-content">
                            <a href="/admin-profile.html">Profil Ayarları</a>
                            <a href="/admin-settings.html">Site Ayarları</a>
                            <a href="/categories.html">Kategorizasyon</a>
                            <button id="logout-button" class="logout-button">Çıkış Yap</button>
                        </div>
                    </div>`;
                 setupUserMenu();
                 setupThemeToggle();
                 return true;
            } else {
                 showToast('Bu sayfaya erişim yetkiniz yok.', 'error');
                 setTimeout(() => { window.location.href = '/login.html'; }, 1500);
                 return false;
            }
        }

        function setupThemeToggle() {
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            if (!lightBtn || !darkBtn) return;

            const docElement = document.documentElement;

            function updateButtons() {
                if (docElement.classList.contains('dark-mode')) {
                    darkBtn.classList.add('active');
                    lightBtn.classList.remove('active');
                } else {
                    lightBtn.classList.add('active');
                    darkBtn.classList.remove('active');
                }
            }

            lightBtn.addEventListener('click', () => {
                docElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                updateButtons();
            });

            darkBtn.addEventListener('click', () => {
                docElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                updateButtons();
            });

            updateButtons();
        }

        window.onload = async () => {
            const isAdmin = setupHeader();
            if (isAdmin) {
                await loadProduct();
            }
        };
    </script>
</body>
</html>